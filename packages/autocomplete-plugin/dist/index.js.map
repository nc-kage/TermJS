{"version":3,"file":"index.js","sources":["../src/Autocomplete/constants.ts","../src/Autocomplete/index.ts"],"sourcesContent":["export const SHOW_ACTION = 'autocomplete-plugin-show';\nexport const PLUGIN_NAME = 'autocomplete-plugin';\n","import { v1 as uuid } from 'uuid';\nimport {\n  Plugin,\n  ITermInfo,\n  IKeyboardShortcutsManager,\n  ActionShortcutType,\n  InfoType,\n} from '@term-js/term';\nimport { Dropdown, IDropdown } from '@term-js/dropdown-plugin';\nimport '@term-js/dropdown-plugin/dist/index.css';\n\nimport './theme.scss';\nimport css from './index.scss';\n\nimport { PLUGIN_NAME, SHOW_ACTION } from '@Autocomplete/constants';\nimport IAutocomplete from '@Autocomplete/IAutocomplete';\nimport { ListInfoType } from '@Autocomplete/types';\n\nclass Autocomplete extends Plugin implements IAutocomplete {\n  public readonly name: string = PLUGIN_NAME;\n  private listsInfo: ListInfoType[] = [];\n  private activeSuggestions: string[] = [];\n  private dropdownPlugin?: IDropdown;\n\n  private commandList: string[] = [];\n  private active: string = '';\n  private isSetShowHandler: boolean = false;\n\n  public addList(items: string[], actionShortcut: ActionShortcutType, icon?: string) {\n    const info: ListInfoType = {\n      icon, items, actionShortcut, isRegistered: false, uuid: uuid(),\n    };\n    this.listsInfo.push(info);\n    this.registerShortcut(info);\n    return () => this.removeList(info.uuid);\n  }\n\n  public removeList(uuidValue: string) {\n    const { listsInfo, keyboardShortcutsManager } = this;\n    const index = listsInfo.findIndex(item => item.uuid === uuidValue);\n    if (index < 0) return;\n    const listInfo = listsInfo[index];\n    listsInfo.splice(index, 1);\n    if (keyboardShortcutsManager) {\n      keyboardShortcutsManager.removeShortcut(SHOW_ACTION, listInfo.actionShortcut);\n    }\n  }\n\n  public setTermInfo(termInfo: ITermInfo, keyboardShortcutsManager: IKeyboardShortcutsManager) {\n    super.setTermInfo(termInfo, keyboardShortcutsManager);\n    this.registerShortcut();\n    this.setDropdownPlugin();\n  }\n\n  public updateTermInfo(termInfo: ITermInfo) {\n    const { termInfo: termInfoPrev, active } = this;\n    const prevValue = termInfoPrev?.edit.value;\n    const currentValue = termInfo.edit.value;\n    super.updateTermInfo(termInfo);\n    if (active && currentValue && prevValue !== currentValue) {\n      this.setSuggestions();\n      this.showSuggestions();\n    } else if (active && !currentValue) {\n      this.clear();\n    }\n  }\n\n  public clear() {\n    this.hideSuggestionsList();\n    this.active = '';\n    super.clear();\n  }\n\n  public destroy() {\n    this.unregisterShortcut();\n    this.dropdownPlugin?.hide();\n    super.destroy();\n  }\n\n  private unregisterShortcut() {\n    const { keyboardShortcutsManager } = this;\n    if (keyboardShortcutsManager) keyboardShortcutsManager.removeShortcut(SHOW_ACTION);\n  }\n\n  private registerShortcut(info?: ListInfoType) {\n    const { keyboardShortcutsManager, listsInfo, isSetShowHandler } = this;\n    if (!keyboardShortcutsManager || (info && info.isRegistered)) return;\n    if (info) {\n      keyboardShortcutsManager.addShortcut(SHOW_ACTION, info.actionShortcut, info.uuid);\n      info.isRegistered = true;\n    } else {\n      listsInfo.forEach(item => this.registerShortcut(item));\n    }\n    if (!isSetShowHandler) {\n      keyboardShortcutsManager.addListener(SHOW_ACTION, this.onAutocomplete);\n      this.isSetShowHandler = true;\n    }\n  }\n\n  private setDropdownPlugin() {\n    const { termInfo } = this;\n    if (!termInfo) return;\n    const dropdownPlugin = termInfo.pluginManager.getPlugin(Dropdown);\n    if (dropdownPlugin) {\n      this.dropdownPlugin = dropdownPlugin as IDropdown;\n    } else {\n      this.dropdownPlugin = new Dropdown();\n      termInfo.pluginManager.register(this.dropdownPlugin);\n    }\n  }\n\n  private onAutocomplete = (action: string, e: Event, info?: { shortcut?: InfoType }) => {\n    const { dropdownPlugin, listsInfo, active } = this;\n    const infoUuid = info?.shortcut;\n    if (!infoUuid || (active && active !== infoUuid)) return;\n    this.commandList = listsInfo.find(item => item.uuid === infoUuid)?.items || [];\n    e.stopPropagation();\n    e.preventDefault();\n    if (dropdownPlugin && this.setSuggestions()) {\n      this.active = infoUuid as string;\n      dropdownPlugin.isActionsLock = true;\n      this.showSuggestions();\n      setTimeout(() => dropdownPlugin.isActionsLock = false, 0);\n    }\n  }\n\n  private setSuggestions(): boolean {\n    const { termInfo, commandList } = this;\n    if (!termInfo) return this.setNewSuggestions([]);\n    const { caret: { position }, edit: { value } } = termInfo;\n    return this.setNewSuggestions(position !== value.length\n      ? []\n      : commandList\n        .filter(command => command.indexOf(value) === 0 && command !== value));\n  }\n\n  private setNewSuggestions(newActiveSuggestions: string[]): boolean {\n    const { activeSuggestions } = this;\n    this.activeSuggestions = newActiveSuggestions;\n    return activeSuggestions.length !== newActiveSuggestions.length\n      || newActiveSuggestions.some((item, i) => item !== activeSuggestions[i]);\n  }\n\n  private showSuggestions() {\n    const { activeSuggestions } = this;\n    if (activeSuggestions.length) {\n      this.renderSuggestionsList();\n    } else {\n      this.clear();\n    }\n  }\n\n  private renderSuggestionsList() {\n    const { dropdownPlugin, activeSuggestions, termInfo, active, listsInfo } = this;\n    const value = termInfo?.edit.value;\n    if (!dropdownPlugin || !value) return;\n    const icon = listsInfo.find(item => item.uuid === active)?.icon;\n    dropdownPlugin.show(activeSuggestions, {\n      onSelect: this.onSelect,\n      onClose: this.onClose,\n      append: icon,\n      className: icon ? css.withIcon : '',\n    });\n    dropdownPlugin.highlight = value.trim();\n  }\n\n  private hideSuggestionsList() {\n    const { dropdownPlugin } = this;\n    if (dropdownPlugin) dropdownPlugin.hide();\n    this.activeSuggestions = [];\n  }\n\n  private onSelect = (text: string) => {\n    const { termInfo } = this;\n    if (termInfo) {\n      const { edit } = termInfo;\n      edit.focus();\n      edit.write(text.replace(edit.value, ''));\n    }\n    this.clear();\n  }\n\n  private onClose = () => {\n    this.activeSuggestions = [];\n    this.active = '';\n  }\n}\n\nexport default Autocomplete;\n"],"names":["Plugin","uuid","dropdownPlugin","Dropdown"],"mappings":"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"}